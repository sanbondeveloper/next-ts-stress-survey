# Stress-Survey

## 프로젝트 소개

스트레스 자가진단 설문지

### 요구사항

- Node.js 18.17
- NPM 9.6.7

### 실행 방법

- `.env` 파일 생성

```
DATABASE_URL="file:./dev.db"
SECRET_KEY=YOUR_SECRET_KEY
```

- 로그인 계정

  - email: test@test.com
  - password: 1234

- 실행 명령어

```
npm run build
npm run start
```

## 기능 소개

### 사용자 정보 입력 및 저장

초기 페이지에서 팀과 이름을 입력한 뒤 이를 저장합니다.

- 팀과 이름이 모두 입력되었을 경우에만 버튼을 활성화하기 위해 제어 컴포넌트 방식을 사용했습니다.
- 애플리케이션 전역에서 사용자 정보를 사용하기 위해 설문조사 페이지로 이동할 때 사용자 정보를 Recoil 상태에 저장했습니다.
  - Context를 사용하면 렌더링 성능을 고려해 상태와 업데이트 함수에 대해 컨텍스트를 분리해야 합니다. 이렇게 하면 하나의 상태 당 최소 2개 이상의 Context가 생기고 이는 코드가 복잡해질 수 있습니다. 따라서 내부적으로 렌더링 성능 최적화를 지원하고 리액트의 상태관리 방식과 비슷한 Recoil을 사용했습니다.
  - 현재 구현 상태는 사용자가 설문조사 페이지에서 새로고침을 하면 Recoil에 저장되어 있는 사용자 정보가 없어집니다. 그래서 로컬스토리지에 저장하는 방식을 고민했지만, Recoil에 저장하는 방식을 유지했고 사용자가 설문조사 페이지에서 새로고침을 하면 사용자 정보 입력 즉, 초기 페이지로 이동되게 구현했습니다. URL 입력창을 통해 설문 조사 페이지로 바로 접속해도 초기 페이지로 이동합니다.

### 설문조사 질문 데이터 가져오기

총 5개의 질문으로 이루어진 데이터를 서버 컴포넌트에서 fetch API로 가져왔습니다.

- 질문 데이터는 상수가 아닌 JSON 파일로 선언했습니다.
  - 상수로 선언하면 애플리케이션 내부에서 고정되는 값이라고 생각했고 JSON 파일로 선언하는게 맞다고 판단했습니다.
- error.tsx 특수 파일을 통해 데이터 패칭 실패 등 오류가 발생했을 때 복구를 위한 fallback UI를 구현했습니다.

### Multi Step Form

질문을 하나씩 보여주며 이전 질문 또는 다음 질문으로 이동할 수 있습니다.

- 5지선다, 주관식 문제의 경우 보기 중 하나를 선택하거나 답변을 입력해야 다음 버튼을 활성화시켰습니다.

  - 활성화 여부를 컴포넌트 내부에서 판단하는 것보다 외부에서 판단하는 게 좋다고 판단해 `<MultiStepForm />` 내부에서 질문 항목과 현재 순서를 인수로 받아서 활성화 여부를 컴포넌트 외부에서 판단할 수 있는 prop을 전달했습니다.

  ```tsx
  <MultiStepForm
    items={questions}
    ...
    validationFn={(item, step) => {
      const value = formValues[`#${step + 1}`]; // 현재 선택한 값

      if (item.type === 'RADIO' && (!value || value?.length === 0)) return false;
      if (item.type === 'INPUT' && (!value || value?.length === 0)) return false;

      return true;
    }}
  >
    ...
  </MultiStepForm>
  ```

- Render Props 패턴을 활용해 질문을 이동하는 로직하고 질문에 따라 반환할 JSX를 분리했습니다.

  - 재사용성, 확장성, 유연성을 고려하여 로직과 디자인을 분리했습니다.

  ```tsx
  <MultiStepForm
    items={questions}
    ...
  >
    {(item) => {
      const { type } = item;

      if (type === 'RADIO') return <RadioGroup question={item} />;
      else if (type === 'CHECKBOX') return <CheckboxGroup question={item} />;
      else return <SubjectiveInput question={item} />;
    }}
  </MultiStepForm>
  ```

- 마우스 없이 키보드 조작으로만 사용자가 폼에 입력을 할 수 있도록 했습니다.

  - Tab으로 포커스를 이동할 수 있고 Enter로 선택할 수 있습니다.

- 주관식 문제는 숫자만 입력할 수 있고 0은 입력할 수 없으며 10을 초과하는 숫자를 입력하면 10으로 변경됩니다.

  - 이를 구현하기 위해 처음에는 `<input />`의 type을 number로 지정했습니다. 지수표기법에 해당하는 문자 `e`가 입력되는 오류가 발생했습니다.
  - 단순한 입력 뿐아니라 복사 & 붙여넣기도 고려해서 구현했습니다.

- 사용자가 선택한 값 또는 입력한 값은 즉시 Recoil 상태에 저장됩니다.

  - Recoil 상태에 저장했기 때문에 설문조사 페이지에서 새로고침을 하면 저장된 상태가 사라집니다. 이때 사용자 정보도 Recoil 상태로 저장했기 때문에 같이 사라집니다. 따라서 설문조사 페이지에서 새로고침하면 초기 페이지로 이동합니다.

### 설문 결과 저장하기

설문조사 페이지에서 폼 제출 시 IndexedDB에 사용자의 설문 결과를 저장합니다.

- 대용량의 데이터를 저장 및 관리하기 위해 용량 제한이 있는 LocalStorage 대신 IndexedDB를 사용했습니다.
- 폼 제출 후 사용자가 입력한 값을 초기화하지 않아 새로고침 없이 다시 설문조사를 실행할 때 기존 데이터가 남아있는 문제가 발생했습니다.

### Dialog 구현

설문조사 페이지에서 폼 제출 시 로그인 Dialog가 화면에 보여집니다.

- `<Dialog />`를 Root Layout에서 렌더링했습니다.
  - 애플리케이션 전역에서 사용되기에 모든 경로에 적용되는 Root Layout에 렌더링했습니다.
- Dialog의 제목, 설명, 노출 여부 등 상태를 Recoil로 관리합니다.
  - Dialog를 화면에 표시하고 싶을 때 Dialog의 상태를 변경시킵니다.

### 대시보드 페이지 진입 인증

로그인을 통해 권한이 있는 사용자만 대시보드 페이지에 접속할 수 있습니다.

- ORM 프레임워크인 Prisma와 경량의 파일 기반 데이터베이스인 SQLite를 통합하여 데이터베이스 인프라를 구축했습니다.

  - Prisma는 개발자가 직접 SQL을 작성하지 않아도 되고 어떤 데이터베이스(NoSQL 포함)를 사용하든 동일한 방식으로 데이터 모델링을 할 수 있도록 자체적인 스키마 문법을 제공합니다.
  - SQLite는 별도의 서버 없이도 운영이 가능하며, 설치나 구성이 필요 없어 개발 과정을 간소화할 수 있습니다.

- 로그인 요청에 관한 서버측 코드를 실행하기 위해 Server Actions을 사용했습니다.

  - Server Actions은 서버에서 실행되는 비동기 함수로 서버측 코드를 작성할 수 있습니다.

- 로그인 인증 성공시 accessToken을 발급합니다. accessToken이 있어야 대시보드 페이지에 접속할 수 있습니다.

  - jsonwebtoken 라이브러리를 사용하여 토큰을 발급하고 verify 했습니다.

### 차트

팀별 총합, 평균, 표준편차, 종합 차트를 제공합니다.

- 수학적인 차트가 아닌 모던한 차트를 제공하는 Chart.js 라이브러리를 사용했습니다.

### 반응형 디자인

- 사용자 정보 입력 페이지

![1](https://github.com/sanbondeveloper/next-ts-stress-survey/assets/146537655/826a1113-2f1d-4ede-bc46-3f53bea8e998)

- 설문조사 페이지

![2](https://github.com/sanbondeveloper/next-ts-stress-survey/assets/146537655/269c4ef5-d80c-4028-b9e6-8c81595a2a28)

- Dialog

![3](https://github.com/sanbondeveloper/next-ts-stress-survey/assets/146537655/77e82794-97b3-4794-802a-be8aba9eb281)

- 대시보드 페이지

![4](https://github.com/sanbondeveloper/next-ts-stress-survey/assets/146537655/dc8fff2c-1f47-45c6-9c7e-f96e7325d81f)

## 할 일

### 기본 요구사항

- [x] 문제 만들기
  - [x] 주제 정하기
  - [x] 5지선다 문제 (1~5점으로 환산할 수 있어야 함)
  - [x] 주관식 문제 (1~10 점수 입력)
  - [x] 5지선다 다중 선택 (문제의 답은 선택한 값의 합)
- [x] 사용자 정보 입력 페이지
  - [x] 팀과 이름을 입력받는다.
  - [x] 팀과 이름을 입력해야 설문 조사 페이지로 이동할 수 있다.
- [x] 설문 조사 페이지
  - [x] 새로고침 시 사용자 정보 입력 페이지로 이동한다.
  - [x] 사용자 정보 미입력 시 사용자 정보 입력 페이지로 이동한다.
  - [x] 질문 데이터를 가져온다.
  - [x] 폼 제출 시 사용자 정보 및 점수를 애플리케이션 저장소에 저장한다.
  - [x] 제출 성공 시 성공 메시지를 보여주고 대시보드 페이지로 이동한다.
  - [x] 제출 실패 시 실패 메시지를 보여주고 현재 페이지를 유지한다.
  - [x] 멀티 스텝 폼 구현
    - [x] 현재 스텝을 표시한다.
    - [x] 다음, 이전 버튼을 구현한다.
    - [x] 조건을 충족하지 못하는 경우 다음 버튼을 비활성화한다.
  - [x] 5지선다 문제 컴포넌트 구현
    - [x] 보기 중 하나만 선택할 수 있다.
    - [x] 보기 중 하나를 선택해야 다음 문제로 넘어갈 수 있다.
    - [x] 보기 중복을 고려해 해시값을 붙인다.
  - [x] 주관식 문제 컴포넌트 구현
    - [x] 1~10 사이의 숫자만 입력할 수 있다.
    - [x] 복사 & 붙여넣기를 고려한다.
  - [x] 5지선다 다중 선택 컴포넌트 구현
    - [x] 보기 중 여러개 선택할 수 있다.
    - [x] 보기 중복을 고려해 해시값을 붙인다.
- [x] 대시보드 페이지
  - [x] 사용자가 입력한 데이터를 가져온다.
  - [x] 팀별 총합, 평균, 표준편차 등 차트 구현
- [x] 마우스 없이 키보드로만 폼 입력 가능하게 하기
- [x] 다이얼로그 구현
- [x] 반응형 디자인 적용
- [x] 대시보드 페이지 진입 인증 처리

## 커밋 컨벤션

| Type     | 설명                                                                                                  |
| -------- | ----------------------------------------------------------------------------------------------------- |
| Feat     | 새로운 기능 추가                                                                                      |
| Fix      | 버그 수정                                                                                             |
| Refactor | 코드 리팩토링, 파일 혹은 폴더명을 수정하거나 옮기는 작업만인 경우, 파일을 삭제하는 작업만 수행한 경우 |
| Style    | CSS 및 레이아웃 작업수정                                                                              |
| Docs     | 문서 수정                                                                                             |
| Chore    | 설정 관련                                                                                             |
